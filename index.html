<!DOCTYPE html>
<html lang="en">
  <head>
    <title>RunItUp</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#1E3A8A" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <link rel="manifest" href="/manifest.json" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html,
      body {
        min-height: 100vh;
        min-height: 100svh;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-800 via-indigo-900 to-purple-900 text-white min-h-screen"
  >
    <div
      id="app"
      class="relative z-10 flex flex-col items-center p-4 min-h-screen"
    >
      <div class="container mx-auto p-4 max-w-md">
        <h1 class="text-3xl font-bold text-center mb-6">RunItUp</h1>

        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-6 mb-6">
          <h2 class="text-2xl font-semibold mb-4">Your Stats</h2>
          <p class="text-lg">
            Total Distance: {{ totalDistance.toFixed(2) }} miles
          </p>
          <p class="text-lg">Total Time: {{ formatTime(totalTime) }}</p>
          <p class="text-lg">XP: {{ xp }}</p>
        </div>

        <div class="bg-gray-800 bg-opacity-50 rounded-lg p-6 mb-6">
          <h2 class="text-2xl font-semibold mb-4 flex items-center">
            üê¢ Level: {{ level }}
            <span class="ml-2 text-sm text-gray-400"
              >({{ xp }}/{{ xpToNextLevel }} XP to {{ nextLevelIcon }} {{
              nextLevelName }})</span
            >
          </h2>
          <div class="w-full bg-gray-600 rounded-full h-2.5 mt-2">
            <div
              class="bg-green-400 h-2.5 rounded-full"
              :style="{ width: xpProgress + '%' }"
            ></div>
          </div>
        </div>

        <div class="flex flex-col space-y-4 mb-6">
          <button
            @click="startWorkout"
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300"
          >
            Start Workout
          </button>
          <button
            @click="logRun"
            class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300"
          >
            Log a Run
          </button>
        </div>

        <div
          v-if="runHistory.length > 0"
          class="bg-gray-800 bg-opacity-50 rounded-lg p-6 mb-6"
        >
          <h2 class="text-2xl font-semibold mb-4">Run History</h2>
          <ul>
            <li
              v-for="(run, index) in runHistory"
              :key="index"
              class="mb-2 pb-2 border-b border-gray-700 last:border-b-0"
            >
              <p><strong>Date:</strong> {{ run.date }}</p>
              <p>
                <strong>Distance:</strong> {{ run.distance.toFixed(2) }} miles
              </p>
              <p><strong>Time:</strong> {{ formatTime(run.time) }}</p>
              <p><strong>XP Earned:</strong> {{ run.xpEarned }}</p>
            </li>
          </ul>
        </div>
        <p v-else class="text-center text-gray-400 mt-4">No runs logged yet.</p>
      </div>

      <footer class="mt-8 text-center text-gray-400 text-sm">
        <p>&copy; 2025 RunItUp. All rights reserved.</p>
      </footer>
    </div>

    <script type="module">
      import {
        createApp,
        ref,
        computed,
      } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

      // Function to format time (re-used from previous examples)
      function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        const pad = (num) => String(num).padStart(2, "0");
        return `${pad(h)}:${pad(m)}:${pad(s)}`;
      }

      createApp({
        setup() {
          const totalDistance = ref(
            parseFloat(localStorage.getItem("totalDistance") || "0")
          );
          const totalTime = ref(
            parseInt(localStorage.getItem("totalTime") || "0", 10)
          );
          const xp = ref(parseInt(localStorage.getItem("xp") || "0", 10));
          const runHistory = ref(
            JSON.parse(localStorage.getItem("runHistory") || "[]")
          );

          const levels = [
            { name: "Turtle", xpNeeded: 0, icon: "üê¢" },
            { name: "Snail", xpNeeded: 100, icon: "üêå" },
            { name: "Rabbit", xpNeeded: 250, icon: "üêá" },
            { name: "Deer", xpNeeded: 500, icon: "ü¶å" },
            { name: "Cheetah", xpNeeded: 1000, icon: "üêÜ" },
          ];

          const level = computed(() => {
            for (let i = levels.length - 1; i >= 0; i--) {
              if (xp.value >= levels[i].xpNeeded) {
                return levels[i].name;
              }
            }
            return levels[0].name;
          });

          const nextLevel = computed(() => {
            const currentLevelIndex = levels.findIndex(
              (lvl) => lvl.name === level.value
            );
            if (currentLevelIndex < levels.length - 1) {
              return levels[currentLevelIndex + 1];
            }
            return null; // Max level reached
          });

          const xpToNextLevel = computed(() => {
            if (nextLevel.value) {
              return nextLevel.value.xpNeeded;
            }
            return xp.value; // At max level, display current XP
          });

          const nextLevelIcon = computed(() => {
            if (nextLevel.value) {
              return nextLevel.value.icon;
            }
            return "‚ú®"; // Max level icon
          });

          const nextLevelName = computed(() => {
            if (nextLevel.value) {
              return nextLevel.value.name;
            }
            return "Max Level";
          });

          const xpProgress = computed(() => {
            if (nextLevel.value) {
              const currentLevelXP = levels.find(
                (lvl) => lvl.name === level.value
              ).xpNeeded;
              const progressRange = nextLevel.value.xpNeeded - currentLevelXP;
              const currentProgress = xp.value - currentLevelXP;
              return (currentProgress / progressRange) * 100;
            }
            return 100; // At max level
          });

          const calculateXpEarned = (distance) => {
            return Math.floor(distance * 10); // 10 XP per mile
          };

          const saveStats = () => {
            localStorage.setItem(
              "totalDistance",
              totalDistance.value.toString()
            );
            localStorage.setItem("totalTime", totalTime.value.toString());
            localStorage.setItem("xp", xp.value.toString());
            localStorage.setItem(
              "runHistory",
              JSON.stringify(runHistory.value)
            );
          };

          const startWorkout = () => {
            alert("Workout started! (Feature under development)");
            // Here you would integrate actual GPS tracking, timers, etc.
            // For now, it's just a placeholder.
          };

          const logRun = () => {
            const distanceInput = prompt("Enter run distance in miles:");
            const timeInput = prompt(
              "Enter run time in HH:MM:SS (e.g., 00:30:00):"
            );

            if (distanceInput && timeInput) {
              const distance = parseFloat(distanceInput);
              const timeParts = timeInput.split(":").map(Number);
              const timeInSeconds =
                (timeParts[0] || 0) * 3600 +
                (timeParts[1] || 0) * 60 +
                (timeParts[2] || 0);

              if (
                !isNaN(distance) &&
                distance > 0 &&
                !isNaN(timeInSeconds) &&
                timeInSeconds >= 0
              ) {
                totalDistance.value += distance;
                totalTime.value += timeInSeconds;
                const xpEarned = calculateXpEarned(distance);
                xp.value += xpEarned;

                const runDate = new Date().toLocaleDateString("en-US", {
                  year: "numeric",
                  month: "short",
                  day: "numeric",
                });

                runHistory.value.unshift({
                  // Add to the beginning
                  date: runDate,
                  distance: distance,
                  time: timeInSeconds,
                  xpEarned: xpEarned,
                });

                saveStats();
                alert(`Run logged! You earned ${xpEarned} XP.`);
              } else {
                alert(
                  "Invalid input. Please enter valid numbers for distance and time."
                );
              }
            }
          };

          // PWA Installation Prompt Logic
          const installPromptEvent = ref(null);

          window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            installPromptEvent.value = e;
          });

          function showInstallPrompt() {
            // Only show custom prompt if the native one hasn't been shown or if it's iOS and not standalone
            if (installPromptEvent.value) {
              // For Android, we can trigger the native prompt
              // installPromptEvent.value.prompt(); // Uncomment if you want to explicitly trigger Android prompt
              // installPromptEvent.value.userChoice.then((choiceResult) => {
              //   if (choiceResult.outcome === 'accepted') {
              //     console.log('User accepted the A2HS prompt');
              //   } else {
              //     console.log('User dismissed the A2HS prompt');
              //   }
              //   installPromptEvent.value = null;
              // });
            } else if (
              navigator.userAgent.match(/iPhone|iPad|iPod/i) &&
              !window.matchMedia("(display-mode: standalone)").matches
            ) {
              alert(
                "To install RunItUp, tap the Share icon and select 'Add to Home Screen'."
              );
            }
          }

          // Show the prompt after 5 seconds, giving the user some time to browse
          setTimeout(showInstallPrompt, 5000);

          // Initial load from localStorage
          saveStats(); // To ensure initial values are saved if localStorage is empty

          return {
            totalDistance,
            totalTime,
            xp,
            level,
            xpToNextLevel,
            nextLevelIcon,
            nextLevelName,
            xpProgress,
            runHistory,
            formatTime,
            startWorkout,
            logRun,
          };
        },
      }).mount("#app");

      // Service Worker Registration
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              console.log(
                "ServiceWorker registration successful with scope: ",
                registration.scope
              );
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        });
      }
    </script>
  </body>
</html>
